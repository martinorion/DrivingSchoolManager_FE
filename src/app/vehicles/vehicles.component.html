<section class="container">
  @if (error()) { <mat-card class="mb-4"><div class="alert alert--error access-message">{{ error() }}</div></mat-card> }
  <div class="form">
    <form class="auth-form" (ngSubmit)="submit()" [formGroup]="form">
      <div class="fields">
        <mat-form-field appearance="outline">
          <mat-label>Názov</mat-label>
          <input matInput formControlName="name" placeholder="Auto pre kurz B" />
          @if (form.controls.name.hasError('required') && (form.controls.name.touched || form.controls.name.dirty)) { <mat-error>Povinné pole</mat-error> }
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Značka</mat-label>
          <input matInput formControlName="brand" placeholder="Škoda" />
          @if (form.controls.brand.hasError('required') && (form.controls.brand.touched || form.controls.brand.dirty)) { <mat-error>Povinné pole</mat-error> }
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Model</mat-label>
          <input matInput formControlName="model" placeholder="Fabia" />
          @if (form.controls.model.hasError('required') && (form.controls.model.touched || form.controls.model.dirty)) { <mat-error>Povinné pole</mat-error> }
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>ŠPZ</mat-label>
          <input matInput formControlName="plateNumber" placeholder="BA123XY" />
          @if (form.controls.plateNumber.hasError('required') && (form.controls.plateNumber.touched || form.controls.plateNumber.dirty)) { <mat-error>Povinné pole</mat-error> }
          @if (form.controls.plateNumber.hasError('duplicate')) { <mat-error>Vozidlo so zadanou ŠPZ už existuje.</mat-error> }
        </mat-form-field>
      </div>
      <button mat-flat-button type="submit" class="btn btn-primary" [disabled]="form.invalid || creating()">
        @if (!creating()) { Vytvoriť vozidlo } @else { <span>Ukladám...</span> }
      </button>
      @if (success()) { <div class="alert alert--success access-message" style="margin-top:.5rem;"><mat-icon>check_circle</mat-icon> {{ success() }}</div> }
    </form>
  </div>

  <div class="toolbar">
    <mat-form-field appearance="outline" class="search-field">
      <mat-label>Hľadať</mat-label>
      <input matInput type="search" [value]="searchTerm()" (input)="onSearch($any($event.target).value)" placeholder="Názov, značka, model alebo ŠPZ" />
      @if (searchTerm()) { <button matSuffix mat-icon-button aria-label="Vyčistiť" (click)="onSearch('')">
        <mat-icon>close</mat-icon>
      </button> }
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>
  </div>

  <div class="list-wrapper">
    @if (loading()) { <div>Načítavam vozidlá...</div> } @else {
      <div class="list">
        @if (!filteredVehicles().length) { <div class="empty">Žiadne vozidlá nevyhovujú hľadaniu.</div> } @else {
          @for (v of pagedVehicles(); track v.id) {
            <div class="row" [class.editing]="editingId() === v.id">
              @if (editingId() === v.id) {
                <div class="form">
                  <form class="auth-form">
                    <div class="fields">
                      <mat-form-field appearance="outline"><mat-label>Názov</mat-label><input matInput [formControl]="editForm.controls.name" />
                        @if (editForm.controls.name.hasError('required') && (editForm.controls.name.touched || editForm.controls.name.dirty)) { <mat-error>Povinné pole</mat-error> }
                      </mat-form-field>
                      <mat-form-field appearance="outline"><mat-label>Značka</mat-label><input matInput [formControl]="editForm.controls.brand" />
                        @if (editForm.controls.brand.hasError('required') && (editForm.controls.brand.touched || editForm.controls.brand.dirty)) { <mat-error>Povinné pole</mat-error> }
                      </mat-form-field>
                      <mat-form-field appearance="outline"><mat-label>Model</mat-label><input matInput [formControl]="editForm.controls.model" />
                        @if (editForm.controls.model.hasError('required') && (editForm.controls.model.touched || editForm.controls.model.dirty)) { <mat-error>Povinné pole</mat-error> }
                      </mat-form-field>
                      <mat-form-field appearance="outline">
                        <mat-label>ŠPZ</mat-label>
                        <input matInput [formControl]="editForm.controls.plateNumber" />
                        @if (editForm.controls.plateNumber.hasError('required') && (editForm.controls.plateNumber.touched || editForm.controls.plateNumber.dirty)) { <mat-error>Povinné pole</mat-error> }
                        @if (editForm.controls.plateNumber.hasError('duplicate')) { <mat-error>Duplicitná ŠPZ</mat-error> }
                      </mat-form-field>
                  </div>
                    <div class="actions">
                      <button mat-stroked-button type="button" (click)="cancelEdit()">Zrušiť</button>
                      <button mat-flat-button type="button" class="btn btn-primary" [disabled]="editForm.invalid || savingEdit()" (click)="saveEdit(v)">Uložiť</button>
                    </div>
                </form>
              </div>
              } @else {
                <div class="item">
                  <div class="main">
                    <div class="name">{{ v.name }}</div>
                    <div class="meta">{{ v.brand }} {{ v.model }} • {{ v.plateNumber }}</div>
                  </div>
                  <div class="actions">
                    <button mat-stroked-button type="button" (click)="startEdit(v)">Upraviť</button>
                    <button mat-flat-button color="warn" type="button" (click)="delete(v)">Odstrániť</button>
                  </div>
              </div>
              }
            </div>
          }
        }
      </div>
    }
    <mat-card-actions class="card-actions">
      <mat-paginator [length]="filteredVehicles().length" [pageIndex]="pageIndex()" [pageSize]="pageSize" [pageSizeOptions]="[pageSize]" (page)="onPage($event)"></mat-paginator>
    </mat-card-actions>
  </div>
</section>
